<script type="module">
    // THREE.js ve GLTFLoader modüllerini import ediyoruz.
    // Bu modüller, 3D ortamı ve modelleri yüklememizi sağlar.
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.126.0/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.126.0/examples/jsm/loaders/GLTFLoader.js';

    const gameContainer = document.getElementById('game-container');
    const scoreElement = document.getElementById('score-3d');
    const gameOverText = document.getElementById('gameOverText-3d');
    
    let scene, camera, renderer, playerCar, road, gameRunning = false, score = 0;
    const otherCars = [];
    
    // Hız kontrolü için yeni değişkenler tanımlıyoruz
    let playerSpeed = 0.1;
    let targetSpeed = 0.1; // Oyuncunun ulaşmak istediği hız
    const acceleration = 0.0002;
    const deceleration = 0.0004;

    // Akıcı hareket için yeni değişkenler tanımlıyoruz
    let targetX = 0; // Oyuncu arabanın gitmek istediği hedef X konumu
    const lateralSpeed = 0.05; // Yana doğru hareket hızı

    // 3D araba modeli için URL tanımlıyoruz.
    const carModelUrl = 'https://threejs.org/examples/models/gltf/car.gltf';
    let playerCarModel, obstacleCarModel;

    const loader = new GLTFLoader();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // Gökyüzü rengi

        camera = new THREE.PerspectiveCamera(75, gameContainer.clientWidth / gameContainer.clientHeight, 0.1, 1000);
        camera.position.z = 5;
        camera.position.y = 2;
        camera.rotation.x = -Math.PI / 8; // Kamerayı biraz aşağı doğru eğiyoruz

        // Işıklandırma ekliyoruz
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5); // Genel ortam ışığı
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8); // Yönlü ışık
        directionalLight.position.set(0, 10, 5);
        scene.add(directionalLight);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(gameContainer.clientWidth, gameContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        gameContainer.appendChild(renderer.domElement);

        // Yol geometrisi ve malzemesi oluşturma
        const roadGeometry = new THREE.BoxGeometry(3.2, 0.1, 1000);
        const roadMaterial = new THREE.MeshLambertMaterial({ color: 0x4a6566 });
        road = new THREE.Mesh(roadGeometry, roadMaterial);
        road.position.z = -500;
        scene.add(road);

        // Yol şeritleri oluşturma
        const roadLines = [];
        for (let i = -500; i < 500; i += 2) {
            const lineGeometry = new THREE.BoxGeometry(0.1, 0.1, 1);
            const lineMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });
            const line = new THREE.Mesh(lineGeometry, lineMaterial);
            line.position.set(0, 0.06, i);
            scene.add(line);
            roadLines.push(line);
        }
        window.roadLines = roadLines;

        // 3D modelleri yükleyen fonksiyonu çağırıyoruz
        loadModels();

        // Olay dinleyicileri
        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);
        window.addEventListener('resize', onResize);
        gameContainer.addEventListener('click', startGame);
        
        gameContainer.addEventListener('touchstart', onTouchStart);
        gameContainer.addEventListener('touchend', onTouchEnd);
    }

    function loadModels() {
        // carModelUrl'deki 3D modeli yüklüyoruz.
        loader.load(carModelUrl, function(gltf) {
            // Oyuncu arabası modelini alıp sahneye ekliyoruz
            playerCarModel = gltf.scene;
            playerCarModel.scale.set(0.01, 0.01, 0.01); // Modelin boyutunu küçültüyoruz
            playerCarModel.position.set(0, 0.25, 4);
            playerCarModel.rotation.y = Math.PI; // Arabayı doğru yöne döndürüyoruz
            scene.add(playerCarModel);
            playerCar = playerCarModel;

            // Engeller için modelin bir kopyasını klonluyoruz
            obstacleCarModel = gltf.scene.clone(); 
            spawnInitialCars(); // İlk engelleri oluşturuyoruz
            animate();
        }, undefined, function(error) {
            // Eğer model yüklenemezse, hata mesajı verip varsayılan kutu modellerini kullanıyoruz
            console.error(error);
            console.log("3D model yüklenemedi, varsayılan kutu modelleri kullanılıyor.");
            playerCar = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 1), new THREE.MeshLambertMaterial({ color: 0x27ae60 }));
            playerCar.position.set(0, 0.25, 4);
            scene.add(playerCar);
            
            obstacleCarModel = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 1), new THREE.MeshLambertMaterial({ color: 0xe74c3c }));
            spawnInitialCars();
            animate();
        });
    }

    function startGame() {
        if (gameRunning) return;
        gameRunning = true;
        score = 0;
        playerSpeed = 0.1;
        targetSpeed = 0.1;
        gameOverText.style.display = 'none';
        
        // Arabaların pozisyonlarını rastgele sıfırlıyoruz
        otherCars.forEach(car => {
            const lane = Math.floor(Math.random() * 3) - 1;
            const zPosition = -Math.random() * 200 - 20;
            car.position.set(lane, 0.25, zPosition);
        });
        
        animate();
    }

    function spawnInitialCars() {
        for (let i = 0; i < 20; i++) {
            let car;
            // Model yüklendiyse, 3D modelin kopyasını kullan
            if (obstacleCarModel.type === 'Scene') { 
                car = obstacleCarModel.clone();
                car.scale.set(0.01, 0.01, 0.01);
                car.rotation.y = Math.PI;
            } else { // Model yüklenemediyse, varsayılan kutu modelini kullan
                car = obstacleCarModel.clone();
            }
            const lane = Math.floor(Math.random() * 3) - 1;
            const zPosition = -Math.random() * 200 - 20;
            car.position.set(lane, 0.25, zPosition);
            scene.add(car);
            otherCars.push(car);
        }
    }

    // Klavye kontrolü için tuş basıldığında
    function onKeyDown(event) {
        if (!gameRunning) return;
        if (event.key === 'ArrowLeft') {
            targetX = Math.max(playerCar.position.x - 1, -1); // Hedef konumu sola ayarla
        } else if (event.key === 'ArrowRight') {
            targetX = Math.min(playerCar.position.x + 1, 1); // Hedef konumu sağa ayarla
        } else if (event.key === 'ArrowUp') {
            targetSpeed = 0.2; // Gaz vermek için hızı artır
        } else if (event.key === 'ArrowDown') {
            targetSpeed = 0.05; // Fren yapmak için hızı azalt
        }
    }

    // Klavye kontrolü için tuş bırakıldığında
    function onKeyUp(event) {
        if (!gameRunning) return;
        if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
            targetSpeed = 0.1; // Hızı normale döndür
        }
    }

    // Dokunmatik kontrol için
    let touchMoveDirection = 0; // -1: sol, 0: dur, 1: sağ
    let touchSpeedDirection = 0; // -1: fren, 0: normal, 1: gaz

    function onTouchStart(event) {
        if (!gameRunning || event.touches.length === 0) return;
        
        const touchX = event.touches[0].clientX;
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;

        // Dokunmanın yatay konumu (sağ-sol hareket)
        if (touchX < screenWidth / 2) {
            targetX = Math.max(playerCar.position.x - 1, -1);
        } else if (touchX > screenWidth / 2) {
            targetX = Math.min(playerCar.position.x + 1, 1);
        }

        // Dokunmanın dikey konumu (gaz-fren)
        const touchY = event.touches[0].clientY;
        if (touchY < screenHeight / 2) {
            targetSpeed = 0.2; // Gaz
        } else {
            targetSpeed = 0.05; // Fren
        }
    }

    function onTouchEnd(event) {
        if (!gameRunning) return;
        targetSpeed = 0.1; // Hızı normale döndür
    }

    function update() {
        if (!gameRunning) return;
        
        // Hızı akıcı bir şekilde hedef hıza yaklaştırıyoruz
        playerSpeed += (targetSpeed - playerSpeed) * 0.05;

        // Arabanın yatay pozisyonunu hedef konuma doğru akıcı bir şekilde hareket ettiriyoruz
        playerCar.position.x += (targetX - playerCar.position.x) * lateralSpeed;

        const moveDistance = playerSpeed;
        
        // Yol ve yol şeritlerini hareket ettirme
        road.position.z += moveDistance;
        if(road.position.z > 0) road.position.z = -500;
        
        window.roadLines.forEach(line => {
            line.position.z += moveDistance;
            if(line.position.z > camera.position.z + 10) {
                line.position.z -= 1000;
            }
        });

        // Engel arabalarını hareket ettirme ve döngüye sokma
        otherCars.forEach(car => {
            car.position.z += moveDistance;
            if (car.position.z > camera.position.z + 10) {
                const lane = Math.floor(Math.random() * 3) - 1;
                const zPosition = -Math.random() * 200 - 20;
                car.position.set(lane, 0.25, zPosition);
            }
        });

        // Çarpışma kontrolü
        checkCollisions();

        // Puanı artırma
        score += moveDistance * 10;
        scoreElement.innerText = Math.floor(score);
    }

    function checkCollisions() {
        const playerBox = new THREE.Box3().setFromObject(playerCar);
        otherCars.forEach(car => {
            const carBox = new THREE.Box3().setFromObject(car);
            if (playerBox.intersectsBox(carBox)) {
                // Çarpışma durumunda oyunu durdurma
                gameRunning = false;
                gameOverText.style.display = 'block';
            }
        });
    }

    function onResize() {
        camera.aspect = gameContainer.clientWidth / gameContainer.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(gameContainer.clientWidth, gameContainer.clientHeight);
    }

    function animate() {
        if (gameRunning) {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }
    }

    // Oyunu başlatıyoruz
    init();
</script>
